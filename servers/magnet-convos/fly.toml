# ABOUTME: Fly.io configuration for Convos IRC web client
# ABOUTME: Persistent bouncer with web UI, connects to MagNET via Tailscale

app = 'magnet-convos'
primary_region = 'ord'

[build]
  dockerfile = "../../convos/Dockerfile"
  context = "../.."

[env]
  CONVOS_REVERSE_PROXY = "1"
  CONVOS_HOME = "/data"
  # Default connection via Flycast to leaf servers (load balanced)
  # Uses irc.perl.org alias mapped to flycast IP in entrypoint.sh
  # Port 16667 bypasses go-mmproxy (internal connections don't need PROXY protocol)
  CONVOS_DEFAULT_CONNECTION = "irc://irc.perl.org:16667/%23perl-help"
  TAILSCALE_DOMAIN = "camel-kanyu.ts.net"
  # Branding
  CONVOS_ORGANIZATION_NAME = "MagNET - irc.perl.org"
  CONVOS_ORGANIZATION_URL = "https://irc.perl.org"
  CONVOS_CONTACT = "mailto:chris@prather.org"
  # Default theme for landing page and new users
  CONVOS_DEFAULT_THEME = "magnet"
  CONVOS_DEFAULT_SCHEME = "light"
  # Atheme authentication integration
  # Enable the Atheme auth plugin for NickServ-based authentication
  CONVOS_PLUGINS = "Convos::Plugin::Auth::Atheme"
  # XMLRPC endpoint for login authentication
  CONVOS_AUTH_ATHEME_URL = "http://magnet-atheme.internal:8080/xmlrpc"
  # IRC server for NickServ registration commands
  CONVOS_AUTH_ATHEME_IRC_URL = "irc://magnet-irc.flycast:16667"
  # Domain for user email addresses
  CONVOS_AUTH_ATHEME_DOMAIN = "irc.perl.org"

[mounts]
  source = "convos_data"
  destination = "/data"

[http_service]
  internal_port = 3000
  force_https = true
  auto_stop_machines = "off"
  auto_start_machines = true
  min_machines_running = 1

  [http_service.concurrency]
    type = "connections"
    hard_limit = 100
    soft_limit = 80

[[http_service.checks]]
  grace_period = "30s"
  interval = "30s"
  method = "GET"
  timeout = "5s"
  path = "/"

[[vm]]
  memory = "512mb"
  cpu_kind = "shared"
  cpus = 1
