# ABOUTME: GitHub Actions workflow for automated SSL certificate renewal
# ABOUTME: Triggers magnet-certbot to get Let's Encrypt certs and push to magnet-irc

name: SSL Certificate Renewal

on:
  schedule:
    - cron: '0 0 1 */2 *'  # 1st of every 2nd month at midnight UTC
  workflow_dispatch:        # Manual trigger

env:
  FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}

jobs:
  renew:
    name: Renew SSL Certificates
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Set token on certbot machine
        run: flyctl secrets set FLY_API_TOKEN="$FLY_API_TOKEN" -a magnet-certbot

      - name: Deploy and run certbot
        working-directory: servers/magnet-certbot
        run: flyctl deploy -a magnet-certbot

      - name: Wait for renewal to complete
        run: sleep 180

      - name: Check certbot logs
        run: flyctl logs -a magnet-certbot --no-tail | tail -50

      - name: Remove token from certbot machine
        if: always()
        run: flyctl secrets unset FLY_API_TOKEN -a magnet-certbot || true
